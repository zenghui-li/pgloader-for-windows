<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2023-12-12 Tue 19:01 -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>S-SQL Examples W</title>
<meta name="author" content="Sabra Crolleton" />
<meta name="generator" content="Org Mode" />
<style>
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { }
</style>
<link rel="stylesheet" type="text/css" href="style.css" />
<style>pre.src{background:#343131;color:white;} </style>
</head>
<body>
<div id="content" class="content">
<header>
<h1 class="title">S-SQL Examples W</h1>
</header><nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org8c6bd3c">S-SQL Examples Home Page</a></li>
<li><a href="#when">When</a></li>
<li><a href="#window">Window</a></li>
<li><a href="#with">With</a></li>
<li><a href="#with-recursive">With-recursive</a></li>
</ul>
</div>
</nav>

<div id="outline-container-org8c6bd3c" class="outline-2">
<h2 id="org8c6bd3c"><a href="s-sql-examples.html">S-SQL Examples Home Page</a></h2>
<div class="outline-text-2" id="text-org8c6bd3c">
<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<tbody>
<tr>
<td class="org-left"><a href="s-sql-a.html">A</a></td>
<td class="org-left"><a href="s-sql-b.html">B</a></td>
<td class="org-left"><a href="s-sql-c.html">C</a></td>
<td class="org-left"><a href="s-sql-d.html">D</a></td>
<td class="org-left"><a href="s-sql-e.html">E</a></td>
<td class="org-left"><a href="s-sql-f.html">F</a></td>
<td class="org-left"><a href="s-sql-g.html">G</a></td>
<td class="org-left"><a href="s-sql-h.html">H</a></td>
<td class="org-left"><a href="s-sql-i.html">I</a></td>
<td class="org-left"><a href="s-sql-j.html">J</a></td>
<td class="org-left"><a href="s-sql-k.html">K</a></td>
<td class="org-left"><a href="s-sql-l.html">L</a></td>
<td class="org-left"><a href="s-sql-m.html">M</a></td>
<td class="org-left"><a href="s-sql-n.html">N</a></td>
<td class="org-left"><a href="s-sql-o.html">O</a></td>
<td class="org-left"><a href="s-sql-p.html">P</a></td>
<td class="org-left"><a href="s-sql-r.html">R</a></td>
<td class="org-left"><a href="s-sql-s.html">S</a></td>
<td class="org-left"><a href="s-sql-t.html">T</a></td>
<td class="org-left"><a href="s-sql-u.html">U</a></td>
<td class="org-left"><a href="s-sql-v.html">V</a></td>
<td class="org-left"><a href="s-sql-w.html">W</a></td>
<td class="org-left"><a href="s-sql-special-characters.html">Special Characters</a></td>
<td class="org-left"><a href="calling-postgresql-stored-functions.html">Calling Postgresql Stored Functions and Procedures</a></td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-when" class="outline-2">
<h2 id="when">When</h2>
<div class="outline-text-2" id="text-when">
<div class="org-src-container">
<pre class="src src-lisp">(<span class="org-keyword">let</span> ((param-latitude nil) (param-longitude t))
  (query (<span class="org-builtin">:select</span> 'id 'name
                  (<span class="org-keyword">when</span> param-latitude '0)
                  (<span class="org-keyword">when</span> param-longitude 'longitude)
                  <span class="org-builtin">:from</span> 'countries
                  <span class="org-builtin">:where</span> (<span class="org-builtin">:=</span> 'id 20))))

((20 <span class="org-string">"UK"</span> NIL -2))
</pre>
</div>
</div>
</div>

<div id="outline-container-window" class="outline-2">
<h2 id="window">Window</h2>
<div class="outline-text-2" id="text-window">
<p>
As stated in the postgresql documentation: "When a query involves multiple window functions, it is possible to write out each one with a separate OVER clause, but this is duplicative and error-prone if the same windowing behavior is wanted for several functions. Instead, each windowing behavior can be named in a WINDOW clause and then referenced in OVER". <a href="http://www.postgresql.org/docs/9.1/static/tutorial-window.html">http://www.postgresql.org/docs/9.1/static/tutorial-window.html</a>. They are available in postmodern as of the 29 October 2013 additions to the git repository.
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (<span class="org-builtin">:select</span> (<span class="org-builtin">:over</span> (<span class="org-builtin">:sum</span> 'salary) 'w)
                (<span class="org-builtin">:over</span> (<span class="org-builtin">:avg</span> 'salary) 'w)
                <span class="org-builtin">:from</span> 'empsalary <span class="org-builtin">:window</span>
                (<span class="org-builtin">:as</span> 'w (<span class="org-builtin">:partition-by</span> 'depname <span class="org-builtin">:order-by</span> (<span class="org-builtin">:desc</span> 'salary)))))
</pre>
</div>
</div>
</div>

<div id="outline-container-with" class="outline-2">
<h2 id="with">With</h2>
<div class="outline-text-2" id="text-with">
<p>
With queries are often referred to as Common Table Expressions. They are used as ways to write auxiliary statements for use in a larger query. The Postgresql documentation covers them at <a href="http://www.postgresql.org/docs/current/queries-with.html">http://www.postgresql.org/docs/current/queries-with.html</a>
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query
 (<span class="org-builtin">:with</span>
  (<span class="org-builtin">:as</span> 'upd
       (<span class="org-builtin">:parens</span>
        (<span class="org-builtin">:update</span> 'employees
         <span class="org-builtin">:set</span> 'sales-count (<span class="org-builtin">:=</span> 'sales-count 1)
                 <span class="org-builtin">:where</span> (<span class="org-builtin">:=</span> 'id
                            (<span class="org-builtin">:select</span> 'sales-person
                             <span class="org-builtin">:from</span> 'accounts
                             <span class="org-builtin">:where</span> (<span class="org-builtin">:=</span> 'name <span class="org-string">"Acme Corporation"</span>)))
                 <span class="org-builtin">:returning</span> '*)))
  (<span class="org-builtin">:insert-into</span> 'employees-log
                (<span class="org-builtin">:select</span> '* 'current-timestamp
                         <span class="org-builtin">:from</span>
                         'upd))))
</pre>
</div>
</div>
</div>

<div id="outline-container-with-recursive" class="outline-2">
<h2 id="with-recursive">With-recursive</h2>
<div class="outline-text-2" id="text-with-recursive">
<p>
With-recursive allows the with auxiliary statement to refer to itself. These queries match the following template:
</p>
<div class="org-src-container">
<pre class="src src-text">WITH RECURSIVE [temp table] [column list]
AS (   [seed statement]
UNION ALL   [recursive statement - effectively looping through the table] )

[outer query which specifies the fields to be kept in the final result and throws away the intermediate results]

</pre>
</div>
<p>
Testing with recursive. When working with recursive queries it is important to be sure that the recursive part of the query will eventually return no tuples, or else the query will loop indefinitely. Sometimes, using UNION instead of UNION ALL can accomplish this by discarding rows that duplicate previous output rows. However, often a cycle does not involve output rows that are completely duplicate: it may be necessary to check just one or a few fields to see if the same point has been reached before. The standard method for handling such situations is to compute an array of the already-visited values.
</p>

<p>
A few postmodern samples follow which match up with the <a href="https://www.postgresql.org/docs/current/queries-with.html">postgresql documentation examples:</a>
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query
 (<span class="org-keyword">:with-recursive</span>
     (<span class="org-builtin">:as</span> (<span class="org-builtin">:t1</span> 'n)
          (<span class="org-builtin">:union-all</span> (<span class="org-builtin">:values</span> (<span class="org-builtin">:set</span> 1))
                      (<span class="org-builtin">:select</span> (<span class="org-builtin">:+</span> 'n 1)
                       <span class="org-builtin">:from</span> 't1
                       <span class="org-builtin">:where</span> (<span class="org-builtin">:&lt;</span> 'n 100))))
   (<span class="org-builtin">:select</span> (<span class="org-builtin">:sum</span> 'n) <span class="org-builtin">:from</span> 't1))
 <span class="org-builtin">:single</span>))

(query
 (<span class="org-keyword">:with-recursive</span>
     (<span class="org-builtin">:as</span> (<span class="org-builtin">:included-parts</span> 'sub-part 'part 'quantity)
          (<span class="org-builtin">:union-all</span>
           (<span class="org-builtin">:select</span> 'sub-part 'part 'quantity
            <span class="org-builtin">:from</span> 'parts
            <span class="org-builtin">:where</span> (<span class="org-builtin">:=</span> 'part <span class="org-string">"our-product"</span>))
           (<span class="org-builtin">:select</span> 'p.sub-part 'p.part 'p.quantity
            <span class="org-builtin">:from</span> (<span class="org-builtin">:as</span> 'included-parts 'pr)
                    (<span class="org-builtin">:as</span> 'parts 'p)
                    <span class="org-builtin">:where</span> (<span class="org-builtin">:=</span> 'p.part 'pr.sub-part))))
   (<span class="org-builtin">:select</span> 'sub-part (<span class="org-builtin">:as</span> (<span class="org-builtin">:sum</span> 'quantity) 'total-quantity)
            <span class="org-builtin">:from</span> 'included-parts
            <span class="org-builtin">:group-by</span> 'sub-part)))


(query
 (<span class="org-keyword">:with-recursive</span>
     (<span class="org-builtin">:as</span> (<span class="org-builtin">:search-graph</span> 'id 'link 'data 'depth)
          (<span class="org-builtin">:union-all</span>
           (<span class="org-builtin">:select</span> 'g.id 'g.link 'g.data 1
                    <span class="org-builtin">:from</span> (<span class="org-builtin">:as</span> 'graph 'g))
           (<span class="org-builtin">:select</span> 'g.id 'g.link 'g.data (<span class="org-builtin">:=</span> 'sg.depth 1)
                    <span class="org-builtin">:from</span> (<span class="org-builtin">:as</span> 'graph 'g) (<span class="org-builtin">:as</span> 'search-graph 'sg)
            <span class="org-builtin">:where</span> (<span class="org-builtin">:=</span> 'g.id 'sg.link))))
   (<span class="org-builtin">:select</span> '* <span class="org-builtin">:from</span> 'search-graph)))

(query
 (<span class="org-keyword">:with-recursive</span>
     (<span class="org-builtin">:as</span> (<span class="org-builtin">:search-graph</span> 'id 'link 'data'depth 'path 'cycle)
          (<span class="org-builtin">:union-all</span>
           (<span class="org-builtin">:select</span> 'g.id 'g.link 'g.data 1
                    (<span class="org-builtin">:[]</span> 'g.f1 'g.f2) nil
                    <span class="org-builtin">:from</span> (<span class="org-builtin">:as</span> 'graph 'g))
           (<span class="org-builtin">:select</span> 'g.id 'g.link 'g.data (<span class="org-builtin">:=</span> 'sg.depth 1)
                    (:|| 'path (<span class="org-builtin">:row</span> 'g.f1 'g.f2))
                    (<span class="org-builtin">:=</span> (<span class="org-builtin">:row</span> 'g.f1 'g.f2)
                        (<span class="org-builtin">:any*</span> 'path))
                    <span class="org-builtin">:from</span> (<span class="org-builtin">:as</span> 'graph 'g)
                    (<span class="org-builtin">:as</span> 'search-graph 'sg)
            <span class="org-builtin">:where</span> (<span class="org-builtin">:and</span> (<span class="org-builtin">:=</span> 'g.id 'sg.link)
                         (<span class="org-builtin">:not</span> 'cycle)))))
   (<span class="org-builtin">:select</span> '* <span class="org-builtin">:from</span> 'search-graph)))

</pre>
</div>

<p>
As a different example, consider a quicklisp dependency table where the fields are 'depends_on' and 'depended_on'. In other words library staple depends-on alexandria. So one record has "staple" in the depends_on column and "alexandria" in the depended_on column.
</p>

<p>
A function to return a list of all the dependencies of a quicklisp library (assuming the data is in a table called "dependencies") could look like this:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">list-dependencies</span> (lib-name)
  <span class="org-doc">"Returns a list of the names of the direct and indirect libraries depended-on by lib-name."</span>
  (sort (alexandria:flatten
           (postmodern:query
            (<span class="org-keyword">:with-recursive</span>
            (<span class="org-builtin">:as</span> 'children
                 (<span class="org-builtin">:union</span>
                  (<span class="org-builtin">:select</span> 'depended-on
                           <span class="org-builtin">:from</span> 'dependencies
                           <span class="org-builtin">:where</span> (<span class="org-builtin">:=</span> 'depends-on '$1))
                  (<span class="org-builtin">:select</span> 'a.depended-on
                           <span class="org-builtin">:from</span> (<span class="org-builtin">:as</span> 'dependencies 'a)
                           <span class="org-builtin">:inner-join</span> (<span class="org-builtin">:as</span> 'children 'b)
                           <span class="org-builtin">:on</span> (<span class="org-builtin">:=</span> 'a.depends-on 'b.depended-on))))
            (<span class="org-builtin">:select</span> '* <span class="org-builtin">:from</span> 'children))
            lib-name))
      #'string&lt;)))
</pre>
</div>
</div>
</div>
</div>
</body>
</html>